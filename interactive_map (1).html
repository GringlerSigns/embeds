
<!DOCTYPE html>
<html>
<head>
    <title>Interactive Map with Clustering and Filtering</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        #map { height: 600px; }
        .popup-table { border-collapse: collapse; width: 100%; }
        .popup-table th, .popup-table td { border: 1px solid black; padding: 5px; text-align: left; }
    </style>
</head>
<body>
    <h3>Interactive Map with Clustering and Filtering</h3>
    <input type="file" id="fileInput" />
    <br><br>
    <label for="trailerFilter">Trailer #:</label>
    <input type="text" id="trailerFilter" oninput="filterMarkers()" />
    <label for="jobFilter">Job #:</label>
    <input type="text" id="jobFilter" oninput="filterMarkers()" />
    <label for="companyFilter">Company:</label>
    <input type="text" id="companyFilter" oninput="filterMarkers()" />
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
        var map = L.map('map').setView([37.8, -96], 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
        }).addTo(map);

        var markers = L.markerClusterGroup();
        var allMarkers = [];

        document.getElementById('fileInput').addEventListener('change', function(event) {
            var file = event.target.files[0];
            var reader = new FileReader();
            reader.onload = function(e) {
                var data = JSON.parse(e.target.result);
                addMarkers(data);
            };
            reader.readAsText(file);
        });

        function addMarkers(data) {
            markers.clearLayers();
            allMarkers = [];
            data.forEach(function(item) {
                var color = item["Empty Status"] === "Yes" ? "green" : item["Days Out"] >= 350 ? "purple" : "red";
                var marker = L.circleMarker([item.Latitude, item.Longitude], {
                    color: color
                }).bindPopup(createPopupContent(item));
                marker.item = item;
                markers.addLayer(marker);
                allMarkers.push(marker);
            });
            map.addLayer(markers);
        }

        function createPopupContent(item) {
            return `
                <table class="popup-table">
                    <tr><th>Trailer #</th><td>${item["Trailer:"]}</td></tr>
                    <tr><th>Job #</th><td>${item["Job:"]}</td></tr>
                    <tr><th>Shipment #</th><td>${item["Shipment:"]}</td></tr>
                    <tr><th># Days</th><td>${item["Days Out"]}</td></tr>
                    <tr><th>Uprights Out</th><td>${item["Number Uprights Out"]}</td></tr>
                    <tr><th>Status</th><td>${item["Status"]}</td></tr>
                    <tr><th>Empty Status</th><td>${item["Empty Status"]}</td></tr>
                </table>
            `;
        }

        function filterMarkers() {
            var trailerFilter = document.getElementById('trailerFilter').value.toLowerCase();
            var jobFilter = document.getElementById('jobFilter').value.toLowerCase();
            var companyFilter = document.getElementById('companyFilter').value.toLowerCase();

            markers.clearLayers();
            allMarkers.forEach(function(marker) {
                var item = marker.item;
                if (
                    (trailerFilter === "" || item["Trailer:"].toLowerCase().includes(trailerFilter)) &&
                    (jobFilter === "" || item["Job:"].toLowerCase().includes(jobFilter)) &&
                    (companyFilter === "" || item["Company:"].toLowerCase().includes(companyFilter))
                ) {
                    markers.addLayer(marker);
                }
            });
        }
    </script>
</body>
</html>
