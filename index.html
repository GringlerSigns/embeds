<!DOCTYPE html>
<html>
<head>
    <title>Interstate Highway Sign Corp. Trailer Mapping</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        body { font-family: Arial, "Helvetica Neue", Helvetica, sans-serif; font-size: larger; }
        #map { height: 600px; }
        .popup-table { border-collapse: collapse; width: 100%; }
        .popup-table th, .popup-table td { border: 1px solid black; padding: 5px; text-align: left; }
        .highlight { color: red; font-weight: bold; background-color: yellow; }
        ul { list-style-type: none; padding: 0; margin: 0; }
    </style>
</head>
<body>
    <h3>Interstate Highway Sign Corp. Trailer Mapping</h3>
    <p>Upload the most recent <a href="https://interstatehighwaysigncorp.sharepoint.com/sites/Shipping/_layouts/download.aspx?SourceUrl=https://interstatehighwaysigncorp.sharepoint.com/sites/Shipping/Documents/Trailer%20List/Trailer%20List.xlsx">Trailer List</a> file to view the information on the map.</p>
    <input type="file" id="fileInput" />
    <br>
    <p><b>Color Coding:</b></p>
    <ul>
        <li>ðŸŸ¥ Red: <b>Not empty</b> or not loaded (if at HQ)</li>
        <li>ðŸŸ© Green: <b>Empty</b> Trailer</li>
        <li>ðŸŸª Purple: Trailer out 100 days or longer</li>
    </ul>
    
<p><b>Filter by:</b></p>
<label for="trailerFilter"><b>Trailer #</b></label>
<input type="text" id="trailerFilter" oninput="filterMarkers()" />
<label for="jobFilter"><b>Job #</b></label>
<input type="text" id="jobFilter" oninput="filterMarkers()" />
<label for="companyFilter"><b>Customer</b></label>
<input type="text" id="companyFilter" oninput="filterMarkers()" />
<label for="colorFilter"><b>Status</b></label>
<select id="colorFilter" onchange="filterMarkers()">
    <option value="">All</option>
    <option value="red">Red (Not empty)</option>
    <option value="green">Green (Empty)</option>
    <option value="purple">Purple (100+ days out)</option>
</select>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        var map = L.map('map').setView([34.711539, -92.194090], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        var markers = L.markerClusterGroup();
        var allMarkers = [];

        document.getElementById('fileInput').addEventListener('change', function(event) {
            var file = event.target.files[0];
            var reader = new FileReader();
            if (file.name.endsWith('.xlsx')) {
                reader.onload = function(e) {
                    var data = new Uint8Array(e.target.result);
                    var workbook = XLSX.read(data, { type: 'array' });
                    var firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    var jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    addMarkers(jsonData);
                };
                reader.readAsArrayBuffer(file);
            } else if (file.name.endsWith('.json')) {
                reader.onload = function(e) {
                    var data = JSON.parse(e.target.result);
                    addMarkers(data);
                };
                reader.readAsText(file);
            } else {
                alert('Please upload a .json or .xlsx file.');
            }
        });

        function normalizeItem(item) {
            return {
                "Trailer": item["Trailer:"] || item["TRL #"] || "",
                "Job": item["Job:"] || item["Job #"] || "",
                "Shipment": item["Shipment:"] || item["SHP #"] || "",
                "DaysOut": item["Days Out:"] || item["# Days"] || 0,
                "UprightsOut": item["Number Uprights Out:"] || item["Uprights Out"] || "",
                "Status": item["Status:"] || item["Status"] || "",
                "EmptyStatus": item["Empty Status"] || item["Empty"] || "",
                "Company": item["Company"] || item["Customer"] || "",
                "Latitude": item["Latitude"] || item["Lat"] || "",
                "Longitude": item["Longitude"] || item["Lon"] || item["Lng"] || ""
            };
        }

        function addMarkers(data) {
            markers.clearLayers();
            allMarkers = [];
            data.forEach(function(rawItem) {
                var item = normalizeItem(rawItem);
                var statusTags = [];

                if (item["DaysOut"] >= 100) {
                    statusTags.push("purple");
                }
                if (item["EmptyStatus"] === "Yes") {
                    statusTags.push("green");
                }
                if (statusTags.length === 0) {
                    statusTags.push("red");
                }

                item.statusTags = statusTags;

                // Choose primary color for marker icon
                var color = statusTags.includes("purple") ? "purple" :
                            statusTags.includes("green") ? "green" : "red";

                var icon = L.icon({
                    iconUrl: getIconUrl(color),
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
                    shadowSize: [41, 41]
                });

                var marker = L.marker([item.Latitude, item.Longitude], { icon: icon })
                    .bindPopup(createPopupContent(item));
                marker.item = item;
                markers.addLayer(marker);
                allMarkers.push(marker);
            });
            map.addLayer(markers);
        }

        function getIconUrl(color) {
            switch (color) {
                case "green":
                    return "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png";
                case "purple":
                    return "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-violet.png";
                case "red":
                default:
                    return "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png";
            }
        }

        function createPopupContent(item) {
            return `
                <table class="popup-table">
                    <tr><th>Company</th><td>${String(item["Company"])}</td></tr>
                    <tr><th>Trailer #</th><td>${String(item["Trailer"])}</td></tr>
                    <tr><th>Job #</th><td>${String(item["Job"])}</td></tr>
                    <tr><th>Shipment #</th><td>${String(item["Shipment"])}</td></tr>
                    <tr><th># Days Out</th><td>${String(item["DaysOut"])}</td></tr>
                    <tr><th>Uprights Out</th><td>${String(item["UprightsOut"])}</td></tr>
                    <tr><th>Status</th><td>${String(item["Status"])}</td></tr>
                </table>
            `;
        }

        function filterMarkers() {
            var trailerFilter = document.getElementById('trailerFilter').value.toLowerCase();
            var jobFilter = document.getElementById('jobFilter').value.toLowerCase();
            var companyFilter = document.getElementById('companyFilter').value.toLowerCase();
            var colorFilter = document.getElementById('colorFilter').value;

            markers.clearLayers();
            allMarkers.forEach(function(marker) {
                var item = marker.item;
                if (
                    (trailerFilter === "" || String(item["Trailer"]).toLowerCase().includes(trailerFilter)) &&
                    (jobFilter === "" || String(item["Job"]).toLowerCase().includes(jobFilter)) &&
                    (companyFilter === "" || String(item["Company"]).toLowerCase().includes(companyFilter)) &&
                    (colorFilter === "" || item.statusTags.includes(colorFilter))
                ) {
                    markers.addLayer(marker);
                }
            });
        }
    </script>
</body>
</html>
